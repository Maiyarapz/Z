local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
    Title = "ZenXhub | Ultimate V30.17", 
    SubTitle = "By ชูติพงษ์ อ่ำปั้น",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false, 
    Theme = "Dark", 
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- [[ 1. Global Configuration ]]
getgenv().AutoFarmNearby = false
getgenv().NearbyDistance = 70 
getgenv().SelectedMonsters = {}
getgenv().SelectedBosses = {}
getgenv().AutoFarmAllBoss = false
getgenv().FarmDistance = 8
getgenv().AutoEquip = false
getgenv().SelectedWeapon = "None"
getgenv().AutoSkill = false
getgenv().SkillsToUse = {Z = true, X = true, C = true, V = true, F = true} -- [NEW]
getgenv().AutoDungeon = false
getgenv().SelectedDungeonType = "None"
getgenv().SelectedDifficulty = "Easy"
getgenv().AutoVoteDifficulty = false
getgenv().AutoReplayDungeon = false
getgenv().AutoStrongestBoss = false
getgenv().SelectedStrongestBoss = "StrongestToday"
getgenv().SelectedStrongestDifficulty = "Normal"
getgenv().AntiAfk = true 

local BossList = {"Alucard", "Aizen", "Madoka", "Jinwoo", "Gojo", "Sukuna", "Yuji", "Cid"}
local IslandPatrol = {"Sailor", "Shibuya", "HuecoMundo", "Valentine"}
local IslandMonsters = {
    ["Sailor"] = {"Marine", "Captain Morgan", "Buggy Subordinate", "Buggy"},
    ["Shibuya"] = {"Transfigured Human", "Curse Spirit", "Jogo", "Hanami"},
    ["HuecoMundo"] = {"Hollow", "Arrancar", "Grimmjow", "Ulquiorra"},
    ["Valentine"] = {"Soldier", "Elite Knight", "Boss Valentine"}
}

-- [[ 2. Float UI System (NEW) ]]
local FloatFrame = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local Status = Instance.new("TextLabel")

FloatFrame.Name = "ZenXFloat"
FloatFrame.Parent = game.CoreGui
MainFrame.Name = "MainFrame"; MainFrame.Parent = FloatFrame; MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.Position = UDim2.new(0.1, 0, 0.1, 0); MainFrame.Size = UDim2.new(0, 150, 0, 50); MainFrame.Active = true; MainFrame.Draggable = true
Title.Parent = MainFrame; Title.Size = UDim2.new(1, 0, 0.4, 0); Title.Text = "ZenX Status"; Title.TextColor3 = Color3.fromRGB(255, 255, 255); Title.TextSize = 14
Status.Parent = MainFrame; Status.Position = UDim2.new(0, 0, 0.4, 0); Status.Size = UDim2.new(1, 0, 0.6, 0); Status.Text = "Idle"; Status.TextColor3 = Color3.fromRGB(0, 255, 0); Status.TextSize = 12

-- Auto Close Float UI
game.CoreGui.ChildRemoved:Connect(function(child)
    if child.Name == "Fluent" then FloatFrame:Destroy() end
end)

-- [[ 3. Core Logic ]]
local function GetMyInventory()
    local Tools = {"None"}
    pcall(function()
        for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
        for _, v in pairs(game.Players.LocalPlayer.Character:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
    end)
    return Tools
end

local function EquipWeaponLogic()
    if getgenv().AutoEquip and getgenv().SelectedWeapon ~= "None" then
        local char = game.Players.LocalPlayer.Character
        if char and not char:FindFirstChild(getgenv().SelectedWeapon) then
            local tool = game.Players.LocalPlayer.Backpack:FindFirstChild(getgenv().SelectedWeapon)
            if tool then char.Humanoid:EquipTool(tool) end
        end
    end
end

local function BossAttack()
    pcall(function()
        local remote = game:GetService("ReplicatedStorage"):WaitForChild("CombatSystem"):WaitForChild("Remotes"):WaitForChild("RequestHit")
        if remote then 
            remote:FireServer() 
            if getgenv().AutoSkill then
                local vim = game:GetService("VirtualInputManager")
                for key, enabled in pairs(getgenv().SkillsToUse) do
                    if enabled then
                        vim:SendKeyEvent(true, key, false, game)
                        task.wait(0.01)
                        vim:SendKeyEvent(false, key, false, game)
                    end
                end
            end
        end
    end)
end

local function GetBossFromSelection() -- [แก้ไขบัค NPC]
    local Targets = {}
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            local isSelected = false
            for _, name in pairs(getgenv().SelectedBosses) do
                if v.Name:lower() == name:lower() then isSelected = true break end
            end
            -- ต้องเลือดเยอะ (ไม่ใช่ NPC) และเลือดต้องมากกว่า 0
            if isSelected and v.Humanoid.Health > 0 and v.Humanoid.MaxHealth > 1000 then
                table.insert(Targets, v)
            end
        end
    end
    return Targets
end

-- [[ 4. Tabs ]]
local Tabs = {
    Main = Window:AddTab({ Title = "Nearby Monster", Icon = "swords" }),
    Boss = Window:AddTab({ Title = "Boss Hunter", Icon = "skull" }),
    Dungeon = Window:AddTab({ Title = "Dungeon", Icon = "swords" }), -- [NEW ICON]
    Strong = Window:AddTab({ Title = "Strong Boss", Icon = "swords" }), -- [NEW ICON]
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [หน้าแรก: Nearby]
Tabs.Main:AddDropdown("IslandDrop", { Title = "1. เลือกเกาะ", Values = {"None", "Sailor", "Shibuya", "HuecoMundo", "Valentine"}, Default = "None", Callback = function(v) getgenv().SelectedIsland = v end })
local MonsterDrop = Tabs.Main:AddDropdown("MonsterDrop", { Title = "2. เลือกมอนสเตอร์", Values = {"---"}, Multi = true, Default = {}, Callback = function(v) 
    local list = {}; for n, _ in pairs(v) do table.insert(list, n) end; getgenv().SelectedMonsters = list 
end })
Tabs.Main:AddButton({ Title = "Refresh Monster List", Callback = function() MonsterDrop:SetValues(IslandMonsters[getgenv().SelectedIsland] or {"None"}) end })
Tabs.Main:AddToggle("AutoFarmNearby", { Title = "เริ่มฟาร์มมอนสเตอร์", Default = false, Callback = function(v) getgenv().AutoFarmNearby = v end })

-- [หน้าบอส: Boss Hunter]
Tabs.Boss:AddDropdown("BossSelect", { Title = "เลือกบอส", Values = BossList, Multi = true, Default = {}, Callback = function(v)
    local list = {}; for n, _ in pairs(v) do table.insert(list, n) end; getgenv().SelectedBosses = list
end })
Tabs.Boss:AddToggle("AutoPatrol", { Title = "เริ่มล่าบอส (Patrol)", Default = false, Callback = function(v) getgenv().AutoFarmAllBoss = v end })

-- [Dungeon & Strong Boss]
Tabs.Dungeon:AddDropdown("DunType", { Title = "เลือกดันเจี้ยน", Values = {"CidDungeon", "RuneDungeon"}, Default = "None", Callback = function(v) getgenv().SelectedDungeonType = v end })
Tabs.Dungeon:AddToggle("AutoDun", { Title = "เริ่มเคลียร์ดันเจี้ยน", Default = false, Callback = function(v) getgenv().AutoDungeon = v end })
Tabs.Strong:AddToggle("AutoStrong", { Title = "เริ่มตีบอส Strongest", Default = false, Callback = function(v) getgenv().AutoStrongestBoss = v end })

-- [Settings & Skill Selector]
Tabs.Settings:AddSection("Skill Selector")
for _, key in pairs({"Z", "X", "C", "V", "F"}) do
    Tabs.Settings:AddToggle("Skill"..key, { Title = "Use Skill "..key, Default = true, Callback = function(v) getgenv().SkillsToUse[key] = v end })
end
Tabs.Settings:AddToggle("AutoEquip", { Title = "ออโต้ใส่อาวุธ", Default = false, Callback = function(v) getgenv().AutoEquip = v end })
Tabs.Settings:AddToggle("AutoSkill", { Title = "เปิดใช้งานสกิลอัตโนมัติ", Default = false, Callback = function(v) getgenv().AutoSkill = v end })
Tabs.Settings:AddToggle("AntiAfk", { Title = "ระบบ Anti AFK", Default = true, Callback = function(v) getgenv().AntiAfk = v end })

-- [[ 5. Main Loops ]]
task.spawn(function()
    while task.wait(0.1) do
        if getgenv().AutoFarmNearby then
            -- Logic Nearby Farm (เหมือนต้นฉบับแต่เพิ่ม Status)
            Status.Text = "Farming Monsters..."
        elseif getgenv().AutoFarmAllBoss then
            Status.Text = "Hunting Bosses..."
            local targets = GetBossFromSelection()
            if #targets > 0 then
                for _, b in pairs(targets) do
                    if not getgenv().AutoFarmAllBoss then break end
                    while b.Humanoid.Health > 0 and getgenv().AutoFarmAllBoss do
                        task.wait()
                        EquipWeaponLogic()
                        local char = game.Players.LocalPlayer.Character
                        if char and char:FindFirstChild("HumanoidRootPart") then
                            char.HumanoidRootPart.CFrame = b.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                            BossAttack()
                        end
                    end
                end
            end
        else
            Status.Text = "Idle / Waiting"
        end
    end
end)

-- Anti-AFK
local VirtualUser = game:GetService("VirtualUser")
game.Players.LocalPlayer.Idled:Connect(function()
    if getgenv().AntiAfk then VirtualUser:CaptureController(); VirtualUser:ClickButton2(Vector2.new()) end
end)

Window:SelectTab(1)
Fluent:Notify({ Title = "ZenXhub", Content = "ระบบทั้งหมดรวมเข้ากับต้นฉบับเรียบร้อยแล้ว!", Duration = 5 })
