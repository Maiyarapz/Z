local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

-- [[ ระบบปุ่มลอยกะทัดรัด (ZX) พร้อมระบบลบอัตโนมัติ ]]
local ScreenGui = Instance.new("ScreenGui")
local ToggleButton = Instance.new("TextButton")
local UICorner = Instance.new("UICorner")
local UIStroke = Instance.new("UIStroke")

ScreenGui.Name = "ZenXToggleGui"
ScreenGui.Parent = game:GetService("CoreGui")
ScreenGui.ResetOnSpawn = false

ToggleButton.Name = "ZenXButton"
ToggleButton.Parent = ScreenGui
ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
ToggleButton.Position = UDim2.new(0.02, 0, 0.2, 0)
ToggleButton.Size = UDim2.new(0, 45, 0, 45)
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Text = "ZX"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 12.000
ToggleButton.Active = true
ToggleButton.Draggable = true 

UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = ToggleButton

UIStroke.Thickness = 1.5
UIStroke.Color = Color3.fromRGB(255, 255, 255)
UIStroke.Parent = ToggleButton

ToggleButton.MouseButton1Click:Connect(function()
    game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
    game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
end)

-- [[ สร้างหน้าต่าง UI หลัก ]]
local Window = Fluent:CreateWindow({
    Title = "ZenXhub | Ultimate V30.16", 
    SubTitle = "By ชูติพงษ์ อ่ำปั้น (GK Hub System)",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = false, 
    Theme = "Dark", 
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- ลบปุ่มลอยเมื่อปิดหน้าต่าง UI หลัก
Window.OnChain:Connect(function()
    if ScreenGui then ScreenGui:Destroy() end
end)

-- [[ 1. Global Configuration ]]
getgenv().AutoFarmNearby = false
getgenv().NearbyDistance = 70 
getgenv().SelectedMonsters = {}
getgenv().SelectedBosses = {}
getgenv().AutoFarmAllBoss = false
getgenv().FarmDistance = 8
getgenv().AutoEquip = false
getgenv().SelectedWeapon = "None"
getgenv().AutoSkill = false
getgenv().AutoDungeon = false
getgenv().SelectedDungeonType = "None"
getgenv().SelectedDifficulty = "Easy"
getgenv().AutoVoteDifficulty = false
getgenv().AutoReplayDungeon = false
getgenv().AutoStrongestBoss = false
getgenv().SelectedStrongestBoss = "StrongestToday"
getgenv().SelectedStrongestDifficulty = "Normal"
getgenv().AntiAfk = true 

local IslandMonsters = {
    ["Sailor"] = {"Marine", "Captain Morgan", "Buggy Subordinate", "Buggy"},
    ["Shibuya"] = {"Transfigured Human", "Curse Spirit", "Jogo", "Hanami"},
    ["HuecoMundo"] = {"Hollow", "Arrancar", "Grimmjow", "Ulquiorra"},
    ["Valentine"] = {"Soldier", "Elite Knight", "Boss Valentine"}
}
getgenv().SelectedIsland = "None"
local BossList = {"Alucard", "Aizen", "Madoka", "Jinwoo", "Gojo", "Sukuna", "Yuji", "Cid"}
local IslandPatrol = {"Sailor", "Shibuya", "HuecoMundo", "Valentine"}

-- [[ 2. Core Logic Functions (ปรับปรุงความแม่นยำ) ]]

local function GetMyInventory()
    local Tools = {"None"}
    pcall(function()
        for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
        for _, v in pairs(game.Players.LocalPlayer.Character:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
    end)
    return Tools
end

local function EquipWeaponLogic()
    pcall(function()
        if getgenv().AutoEquip and getgenv().SelectedWeapon ~= "None" then
            local char = game.Players.LocalPlayer.Character
            if char and not char:FindFirstChild(getgenv().SelectedWeapon) then
                local tool = game.Players.LocalPlayer.Backpack:FindFirstChild(getgenv().SelectedWeapon)
                if tool then char.Humanoid:EquipTool(tool) end
            end
        end
    end)
end

local function BossAttack()
    pcall(function()
        local remote = game:GetService("ReplicatedStorage"):WaitForChild("CombatSystem"):WaitForChild("Remotes"):WaitForChild("RequestHit")
        if remote then 
            remote:FireServer() 
            if getgenv().AutoSkill then
                local vim = game:GetService("VirtualInputManager")
                for _, key in pairs({"Z", "X", "C", "V", "F"}) do
                    vim:SendKeyEvent(true, key, false, game)
                    task.wait(0.01)
                    vim:SendKeyEvent(false, key, false, game)
                end
            end
        end
    end)
end

local function GetTargetMonster()
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") or #getgenv().SelectedMonsters == 0 then return nil end
    local closest = nil
    local shortestDist = getgenv().NearbyDistance
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") and v ~= char then
            for _, selectedName in pairs(getgenv().SelectedMonsters) do
                if v.Name == selectedName or v.Name:find(selectedName) then
                    local magnitude = (char.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                    if magnitude <= shortestDist then closest = v shortestDist = magnitude end
                end
            end
        end
    end
    return closest
end

local function GetTargetBoss()
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") or #getgenv().SelectedBosses == 0 then return nil end
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") and v.Humanoid.Health > 0 and v ~= char then
            for _, bossName in pairs(getgenv().SelectedBosses) do
                if v.Name:lower():find(bossName:lower()) then return v end
            end
        end
    end
    return nil
end

-- [[ 3. UI Tabs ]]
local Tabs = {
    Main = Window:AddTab({ Title = "Nearby Monster", Icon = "swords" }),
    Boss = Window:AddTab({ Title = "Boss Hunter", Icon = "skull" }),
    Dungeon = Window:AddTab({ Title = "Dungeon", Icon = "castle" }),
    Strong = Window:AddTab({ Title = "Strong Boss", Icon = "zap" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

-- [[ 4. Tab Implementation ]]

-- Nearby Monster
Tabs.Main:AddSection("Smart Island Farm")
local IslandDrop = Tabs.Main:AddDropdown("IslandDrop", { Title = "1. เลือกเกาะ", Values = {"None", "Sailor", "Shibuya", "HuecoMundo", "Valentine"}, Default = "None", Callback = function(v) getgenv().SelectedIsland = v end })
local MonsterDrop = Tabs.Main:AddDropdown("MonsterDrop", { Title = "2. เลือกมอนสเตอร์", Values = {"--- Select Island First ---"}, Multi = true, Default = {}, Callback = function(v) local list = {} for name, _ in pairs(v) do table.insert(list, name) end getgenv().SelectedMonsters = list end })
Tabs.Main:AddButton({ Title = "Refresh Monster List", Callback = function() MonsterDrop:SetValues(IslandMonsters[getgenv().SelectedIsland] or {"None"}) end })
Tabs.Main:AddToggle("AutoFarmNearby", { Title = "เริ่มฟาร์มมอนสเตอร์ที่เลือก", Default = false, Callback = function(Value) getgenv().AutoFarmNearby = Value end })

-- Boss Hunter
Tabs.Boss:AddSection("Boss Hunt Configuration")
Tabs.Boss:AddDropdown("BossSelect", { Title = "เลือกบอสที่จะโจมตี (BossList Only)", Values = BossList, Multi = true, Default = {}, Callback = function(v) local list = {} for name, _ in pairs(v) do table.insert(list, name) end getgenv().SelectedBosses = list end })
Tabs.Boss:AddToggle("AutoPatrol", { Title = "เริ่มโจมตีบอส (Patrol)", Default = false, Callback = function(v) getgenv().AutoFarmAllBoss = v end })

-- Dungeon
Tabs.Dungeon:AddSection("Dungeon Full Clear")
Tabs.Dungeon:AddDropdown("DunType", { Title = "เลือกดันเจี้ยน", Values = {"CidDungeon", "RuneDungeon"}, Default = "None", Callback = function(v) getgenv().SelectedDungeonType = v end })
Tabs.Dungeon:AddDropdown("DunDiff", { Title = "เลือกความยาก", Values = {"Easy", "Medium", "Hard", "Extreme"}, Default = "Easy", Callback = function(v) getgenv().SelectedDifficulty = v end })
Tabs.Dungeon:AddToggle("AutoDun", { Title = "เริ่มเคลียร์ดันเจี้ยน", Default = false, Callback = function(v) getgenv().AutoDungeon = v end })
Tabs.Dungeon:AddToggle("AutoVote", { Title = "Auto Vote", Default = false, Callback = function(v) getgenv().AutoVoteDifficulty = v end })
Tabs.Dungeon:AddToggle("AutoReplay", { Title = "Auto Replay", Default = false, Callback = function(v) getgenv().AutoReplayDungeon = v end })

-- Strong Boss
Tabs.Strong:AddSection("Strongest Boss Farm")
Tabs.Strong:AddDropdown("StrongType", { Title = "เลือกบอส Strongest", Values = {"StrongestToday", "StrongestHistory"}, Default = "StrongestToday", Callback = function(v) getgenv().SelectedStrongestBoss = v end })
Tabs.Strong:AddDropdown("StrongDiff", { Title = "เลือกระดับความยาก", Values = {"Normal", "Medium", "Hard", "Extreme"}, Default = "Normal", Callback = function(v) getgenv().SelectedStrongestDifficulty = v end })
Tabs.Strong:AddToggle("AutoStrong", { Title = "เริ่มตีบอส Strongest", Default = false, Callback = function(v) getgenv().AutoStrongestBoss = v end })

-- Settings
Tabs.Settings:AddSection("Combat Config")
local WeaponDrop = Tabs.Settings:AddDropdown("WeaponDrop", { Title = "เลือกอาวุธ", Values = GetMyInventory(), Default = "None", Callback = function(v) getgenv().SelectedWeapon = v end })
Tabs.Settings:AddButton({ Title = "Refresh Inventory", Callback = function() WeaponDrop:SetValues(GetMyInventory()) end })
Tabs.Settings:AddToggle("AutoEquip", { Title = "ออโต้ใส่อาวุธ", Default = false, Callback = function(v) getgenv().AutoEquip = v end })
Tabs.Settings:AddToggle("AutoSkill", { Title = "ออโต้ใช้สกิล Z-F", Default = false, Callback = function(v) getgenv().AutoSkill = v end })
Tabs.Settings:AddSection("Distance Config")
Tabs.Settings:AddSlider("FarmDist", { Title = "Attack Distance", Default = 8, Min = 0, Max = 15, Rounding = 1, Callback = function(v) getgenv().FarmDistance = v end })
Tabs.Settings:AddSlider("SmartDist", { Title = "Nearby Scan Distance", Default = 70, Min = 0, Max = 1000, Rounding = 1, Callback = function(v) getgenv().NearbyDistance = v end })
Tabs.Settings:AddToggle("AntiAfk", { Title = "Anti AFK", Default = true, Callback = function(v) getgenv().AntiAfk = v end })

-- [[ 5. Runtime Loops ]]

-- Nearby & Boss Loop
task.spawn(function()
    local patrolIdx = 1
    while true do
        task.wait(0.1)
        local char = game.Players.LocalPlayer.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        
        if getgenv().AutoFarmNearby and root then
            local target = GetTargetMonster()
            if target then
                root.Velocity = Vector3.new(0,0,0)
                root.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                EquipWeaponLogic()
                BossAttack()
            end
        elseif getgenv().AutoFarmAllBoss and root then
            local target = GetTargetBoss()
            if target then
                root.Velocity = Vector3.new(0,0,0)
                root.CFrame = target.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                EquipWeaponLogic()
                BossAttack()
            else
                game:GetService("ReplicatedStorage").Remotes.TeleportToPortal:FireServer(IslandPatrol[patrolIdx])
                task.wait(7)
                patrolIdx = (patrolIdx % #IslandPatrol) + 1
            end
        end
    end
end)

-- Dungeon & Strong Boss Loop
task.spawn(function()
    while true do
        task.wait(2)
        if getgenv().AutoDungeon and getgenv().SelectedDungeonType ~= "None" then
            game:GetService("ReplicatedStorage").Remotes.RequestDungeonPortal:FireServer(getgenv().SelectedDungeonType)
            task.wait(2)
            game:GetService("ReplicatedStorage").Remotes.TeleportToPortal:FireServer("Dungeon")
        end
        if getgenv().AutoStrongestBoss then
            game:GetService("ReplicatedStorage").Remotes.TeleportToPortal:FireServer("Shinjuku")
            task.wait(2)
            game:GetService("ReplicatedStorage").Remotes.RequestSpawnStrongestBoss:FireServer(getgenv().SelectedStrongestBoss, getgenv().SelectedStrongestDifficulty)
        end
    end
end)

-- AFK & Votes
task.spawn(function()
    while true do
        task.wait(3)
        if getgenv().AutoVoteDifficulty then pcall(function() game:GetService("ReplicatedStorage").Remotes.DungeonWaveVote:FireServer(getgenv().SelectedDifficulty) end) end
        if getgenv().AutoReplayDungeon then pcall(function() game:GetService("ReplicatedStorage").Remotes.DungeonWaveReplayVote:FireServer("sponsor") end) end
    end
end)

game.Players.LocalPlayer.Idled:Connect(function()
    if getgenv().AntiAfk then game:GetService("VirtualUser"):CaptureController() game:GetService("VirtualUser"):ClickButton2(Vector2.new()) end
end)

Window:SelectTab(1)
Fluent:Notify({ Title = "ZenXhub", Content = "ระบบทั้งหมดพร้อมใช้งานแล้วครับ!", Duration = 5 })
