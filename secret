-- [[ Global Configuration ]]
getgenv().AutoFarmNearby = false
getgenv().NearbyDistance = 70 
getgenv().SelectedMonsters = {}
getgenv().AutoFarmAllBoss = false
getgenv().FarmDistance = 8
getgenv().AutoEquip = false
getgenv().SelectedWeapon = "None"
getgenv().AutoSkill = false
getgenv().AutoDungeon = false
getgenv().AutoDungeonNearby = false
getgenv().SelectedDungeonType = "None"
getgenv().AntiAfk = true 

-- ระบบ Auto Vote
getgenv().AutoReplayDungeon = false
getgenv().AutoVoteDifficulty = false
getgenv().SelectedDifficulty = "Easy"

-- ระบบ Strongest Boss
getgenv().AutoStrongestBoss = false
getgenv().SelectedStrongestBoss = "StrongestToday"
getgenv().SelectedStrongestDifficulty = "Normal"

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
    Name = "ZenX | BotFram",
    LoadingTitle = "Nearby Farm Loop System Loading...",
    ConfigurationSaving = { Enabled = true, FileName = "SailorPiece_V30" }
})

-- ข้อมูลเกม
local BossList = {"Alucard", "Aizen", "Madoka", "Jinwoo", "Gojo", "Sukuna", "Yuji", "Cid", " Anos", " Saber", " Qinshi", " Ichigo", "Gilgamesh"}
local IslandPatrol = {"Boss", "Sailor", "Shibuya", "HuecoMundo", "Valentine", " Academy",}

-- [[ ฟังก์ชันสนับสนุน ]]

-- ระบบ Anti-AFK Logic
local VirtualUser = game:GetService("VirtualUser")
game:GetService("Players").LocalPlayer.Idled:Connect(function()
    if getgenv().AntiAfk then
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
        Rayfield:Notify({
            Title = "Anti-AFK System",
            Content = "ป้องกันการเตะออกจากเซิร์ฟเวอร์เรียบร้อยแล้ว!",
            Duration = 5,
            Image = 4483362458,
        })
    end
end)

local function GetNearbyMonsterList()
    local Monsters = {}
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return {"None"} end
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            if v ~= char and v.Humanoid.Health > 0 and v.Humanoid.MaxHealth > 10 then
                local dist = (char.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist <= getgenv().NearbyDistance then
                    local exists = false
                    for _, name in pairs(Monsters) do if name == v.Name then exists = true break end end
                    if not exists then table.insert(Monsters, v.Name) end
                end
            end
        end
    end
    if #Monsters == 0 then table.insert(Monsters, "None") end
    return Monsters
end

local function GetMyInventory()
    local Tools = {"None"}
    pcall(function()
        for _, v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
        for _, v in pairs(game.Players.LocalPlayer.Character:GetChildren()) do if v:IsA("Tool") then table.insert(Tools, v.Name) end end
    end)
    return Tools
end

local function EquipWeaponLogic()
    pcall(function()
        if getgenv().AutoEquip and getgenv().SelectedWeapon ~= "None" then
            local char = game.Players.LocalPlayer.Character
            if char and not char:FindFirstChild(getgenv().SelectedWeapon) then
                local tool = game.Players.LocalPlayer.Backpack:FindFirstChild(getgenv().SelectedWeapon)
                if tool then char.Humanoid:EquipTool(tool) end
            end
        end
    end)
end

local function BossAttack()
    pcall(function()
        local remote = game:GetService("ReplicatedStorage"):WaitForChild("CombatSystem"):WaitForChild("Remotes"):WaitForChild("RequestHit")
        if remote then 
            remote:FireServer() 
            if getgenv().AutoSkill then
                local vim = game:GetService("VirtualInputManager")
                for _, key in pairs({"Z", "X", "C", "V", "F"}) do
                    vim:SendKeyEvent(true, key, false, game)
                    task.wait(0.01)
                    vim:SendKeyEvent(false, key, false, game)
                end
            end
        end
    end)
end

local function GetBossOnIsland()
    local Targets = {}
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            local nameLower = v.Name:lower()
            for _, bossName in pairs(BossList) do
                if nameLower:find(bossName:lower()) and v.Humanoid.Health > 0 then
                    if v.Humanoid.MaxHealth > 1000 then table.insert(Targets, v) break end
                end
            end
        end
    end
    return Targets
end

local function GetMultiTargetMonster()
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") or #getgenv().SelectedMonsters == 0 then return nil end
    local closest = nil
    local shortestDist = getgenv().NearbyDistance
    for _, v in pairs(game.Workspace:GetDescendants()) do
        local isSelected = false
        for _, selectedName in pairs(getgenv().SelectedMonsters) do if v.Name == selectedName then isSelected = true break end end
        if isSelected and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v:FindFirstChild("HumanoidRootPart") then
            local magnitude = (char.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
            if magnitude <= shortestDist then closest = v shortestDist = magnitude end
        end
    end
    return closest
end

local function GetDungeonEnemy()
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 and v.Humanoid.MaxHealth > 10 and v ~= char then
            return v
        end
    end
    return nil
end

local function GetDungeonNearbyEnemy()
    local player = game.Players.LocalPlayer
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    local closest = nil
    local shortestDist = getgenv().NearbyDistance
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            if v ~= char and v.Humanoid.Health > 0 and v.Humanoid.MaxHealth > 10 then
                local dist = (char.HumanoidRootPart.Position - v.HumanoidRootPart.Position).Magnitude
                if dist <= shortestDist then
                    closest = v
                    shortestDist = dist
                end
            end
        end
    end
    return closest
end

local function GetStrongestBossPrecision()
    local char = game.Players.LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return nil end
    for _, v in pairs(game.Workspace:GetDescendants()) do
        if v:IsA("Model") and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
            if v ~= char and v.Humanoid.Health > 0 then
                if v.Name:lower():find("strongest") and v.Humanoid.MaxHealth >= 100000000 then
                    return v
                end
            end
        end
    end
    return nil
end

-- [[ UI TABS ]]

local FarmTab = Window:CreateTab("Auto Farm", 4483362458)

-- 1. Auto Farm Nearby (เสถียร + ล็อคตัวนิ่ง)
FarmTab:CreateSection("Auto Farm Nearby (Multi-Target)")
local MonsterDropdown = FarmTab:CreateDropdown({
    Name = "Select Monsters to Farm",
    Options = GetNearbyMonsterList(),
    CurrentOption = {},
    MultipleOptions = true,
    Callback = function(Options) getgenv().SelectedMonsters = Options end,
})
FarmTab:CreateButton({
    Name = "Refresh Nearby Monsters",
    Callback = function() MonsterDropdown:Refresh(GetNearbyMonsterList()) end,
})
FarmTab:CreateToggle({
    Name = "Auto Farm Selected Monsters",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoFarmNearby = Value
        task.spawn(function()
            while getgenv().AutoFarmNearby do
                task.wait(0.1)
                local target = GetMultiTargetMonster()
                if target and target:FindFirstChild("HumanoidRootPart") then
                    local targetRoot = target.HumanoidRootPart
                    local targetHumanoid = target:FindFirstChild("Humanoid")
                    while getgenv().AutoFarmNearby and targetHumanoid and targetHumanoid.Health > 0 do
                        task.wait(0.01)
                        local char = game.Players.LocalPlayer.Character
                        local root = char and char:FindFirstChild("HumanoidRootPart")
                        if root and targetRoot then
                            EquipWeaponLogic()
                            root.Velocity = Vector3.new(0, 0, 0)
                            root.RotVelocity = Vector3.new(0, 0, 0)
                            root.CFrame = targetRoot.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                            BossAttack()
                        else
                            break 
                        end
                    end
                else
                    task.wait(0.5)
                end
            end
        end)
    end,
})

-- 2. Island Patrol (ฟังก์ชันเก่า)
FarmTab:CreateSection("Island Patrol")
FarmTab:CreateToggle({
    Name = "Start Island Patrol (Farm all Bosses)",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoFarmAllBoss = Value
        task.spawn(function()
            local islandIndex = 1
            while getgenv().AutoFarmAllBoss do
                local currentIsland = IslandPatrol[islandIndex]
                Rayfield:Notify({Title = "Patrol", Content = "กำลังเดินทางไป: " .. currentIsland})
                game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("TeleportToPortal"):FireServer(currentIsland)
                task.wait(1) 
                local BossesFound = GetBossOnIsland()
                if #BossesFound > 0 then
                    for _, boss in pairs(BossesFound) do
                        if not getgenv().AutoFarmAllBoss then break end
                        if boss and boss:FindFirstChild("Humanoid") and boss.Humanoid.Health > 0 then
                            while getgenv().AutoFarmAllBoss and boss:FindFirstChild("Humanoid") and boss.Humanoid.Health > 0 do
                                task.wait(0.05)
                                EquipWeaponLogic()
                                local char = game.Players.LocalPlayer.Character
                                if char and char:FindFirstChild("HumanoidRootPart") and boss:FindFirstChild("HumanoidRootPart") then
                                    char.HumanoidRootPart.CFrame = boss.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                                    BossAttack()
                                end
                            end
                            task.wait(1)
                        end
                    end
                end
                islandIndex = (islandIndex % #IslandPatrol) + 1
                task.wait(2)
            end
        end)
    end,
})

-- 3. Dungeon Mode (ฟังก์ชันเก่า)
FarmTab:CreateSection("Dungeon Mode")
FarmTab:CreateDropdown({
    Name = "Select Dungeon Type",
    Options = {"CidDungeon", "RuneDungeon", " DoubleDungeon"},
    CurrentOption = {"None"},
    Callback = function(Option) getgenv().SelectedDungeonType = Option[1] end,
})
FarmTab:CreateDropdown({
    Name = "Select Difficulty (Target)",
    Options = {"Easy", "Medium", "Hard", "Extreme"},
    CurrentOption = {"Easy"},
    Callback = function(Option) getgenv().SelectedDifficulty = Option[1] end,
})
FarmTab:CreateToggle({
    Name = "Auto Vote Difficulty",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoVoteDifficulty = Value
        task.spawn(function()
            while getgenv().AutoVoteDifficulty do
                pcall(function()
                    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("DungeonWaveVote"):FireServer(getgenv().SelectedDifficulty)
                end)
                task.wait(3)
            end
        end)
    end,
})
FarmTab:CreateToggle({
    Name = "Auto Vote Replay Dungeon",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoReplayDungeon = Value
        task.spawn(function()
            while getgenv().AutoReplayDungeon do
                pcall(function()
                    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("DungeonWaveReplayVote"):FireServer("sponsor")
                end)
                task.wait(5)
            end
        end)
    end,
})
FarmTab:CreateToggle({
    Name = "Auto Dungeon (Full Clear)",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoDungeon = Value
        task.spawn(function()
            while getgenv().AutoDungeon do
                task.wait(1)
                if getgenv().SelectedDungeonType ~= "None" then
                    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("RequestDungeonPortal"):FireServer(getgenv().SelectedDungeonType)
                    task.wait(2)
                    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("TeleportToPortal"):FireServer("Dungeon")
                    task.wait(5)
                    while getgenv().AutoDungeon do
                        task.wait(0.1)
                        local enemy = GetDungeonEnemy()
                        if enemy then
                            while getgenv().AutoDungeon and enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 do
                                task.wait(0.05)
                                EquipWeaponLogic()
                                local char = game.Players.LocalPlayer.Character
                                if char and char:FindFirstChild("HumanoidRootPart") and enemy:FindFirstChild("HumanoidRootPart") then
                                    char.HumanoidRootPart.CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                                    BossAttack()
                                end
                            end
                        else
                            task.wait(2)
                        end
                    end
                else
                    Rayfield:Notify({Title = "Warning", Content = "เลือก Dungeon ก่อนเปิด!"})
                    getgenv().AutoDungeon = false
                    break
                end
            end
        end)
    end,
})
FarmTab:CreateToggle({
    Name = "Auto Dungeon Nearby (Smart Scan)",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoDungeonNearby = Value
        task.spawn(function()
            while getgenv().AutoDungeonNearby do
                task.wait(0.1)
                local enemy = GetDungeonNearbyEnemy()
                if enemy then
                    while getgenv().AutoDungeonNearby and enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 do
                        task.wait(0.05)
                        EquipWeaponLogic()
                        local char = game.Players.LocalPlayer.Character
                        if char and char:FindFirstChild("HumanoidRootPart") and enemy:FindFirstChild("HumanoidRootPart") then
                            char.HumanoidRootPart.CFrame = enemy.HumanoidRootPart.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                            BossAttack()
                        end
                    end
                end
            end
        end)
    end,
})

-- 4. Strongest Boss Mode (ฟังก์ชันเก่า)
FarmTab:CreateSection("Strongest Boss Mode")
FarmTab:CreateDropdown({
    Name = "Select Boss",
    Options = {"StrongestToday", "StrongestHistory"},
    CurrentOption = {"StrongestToday"},
    Callback = function(Option) getgenv().SelectedStrongestBoss = Option[1] end,
})
FarmTab:CreateDropdown({
    Name = "Select Difficulty",
    Options = {"Normal", "Medium", "Hard", "Extreme"},
    CurrentOption = {"Normal"},
    Callback = function(Option) getgenv().SelectedStrongestDifficulty = Option[1] end,
})
FarmTab:CreateToggle({
    Name = "Auto Farm Strongest Boss",
    CurrentValue = false,
    Callback = function(Value)
        getgenv().AutoStrongestBoss = Value
        task.spawn(function()
            while getgenv().AutoStrongestBoss do
                task.wait(1)
                game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("TeleportToPortal"):FireServer("Shinjuku")
                task.wait(2)
                local spawnArgs = {[1] = getgenv().SelectedStrongestBoss, [2] = getgenv().SelectedStrongestDifficulty}
                game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("RequestSpawnStrongestBoss"):FireServer(unpack(spawnArgs))
                while getgenv().AutoStrongestBoss do
                    task.wait(0.05)
                    local target = GetStrongestBossPrecision()
                    if target then
                        local char = game.Players.LocalPlayer.Character
                        local root = char and char:FindFirstChild("HumanoidRootPart")
                        local tRoot = target:FindFirstChild("HumanoidRootPart")
                        if root and tRoot then
                            root.CFrame = tRoot.CFrame * CFrame.new(0, getgenv().FarmDistance, 0) * CFrame.Angles(math.rad(-90), 0, 0)
                            BossAttack()
                        end
                    else
                        task.wait(3)
                        if getgenv().AutoStrongestBoss then
                           game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("RequestSpawnStrongestBoss"):FireServer(unpack(spawnArgs))
                        end
                    end
                end
            end
        end)
    end,
})

-- [[ TAB: SETTINGS ]]
local SetTab = Window:CreateTab("Settings", 4483362458)

SetTab:CreateSection("System Protection")
SetTab:CreateToggle({
    Name = "Anti-AFK (Idle Kick Protection)",
    CurrentValue = true,
    Callback = function(Value) getgenv().AntiAfk = Value end,
})

SetTab:CreateSection("Combat & Weapon")
local WeaponDropdown = SetTab:CreateDropdown({
    Name = "Select Weapon",
    Options = GetMyInventory(),
    CurrentOption = {"None"},
    Callback = function(Option) getgenv().SelectedWeapon = Option[1] end,
})
SetTab:CreateButton({
    Name = "Refresh Weapon List",
    Callback = function() WeaponDropdown:Refresh(GetMyInventory()) end,
})
SetTab:CreateToggle({
    Name = "Auto Equip Selected Weapon",
    CurrentValue = false,
    Callback = function(Value) getgenv().AutoEquip = Value end,
})
SetTab:CreateToggle({
    Name = "Auto Use Skill (Z,X,C,V,F)",
    CurrentValue = false,
    Callback = function(Value) getgenv().AutoSkill = Value end,
})

SetTab:CreateSection("Farm Configuration")
SetTab:CreateSlider({
    Name = "Attack Distance",
    Range = {0, 15},
    Increment = 1,
    CurrentValue = 8,
    Callback = function(v) getgenv().FarmDistance = v end,
})
SetTab:CreateSlider({
    Name = "Smart Scan Distance (Nearby)",
    Range = {10, 1000},
    Increment = 10,
    CurrentValue = 70,
    Callback = function(v) getgenv().NearbyDistance = v end,
})

Rayfield:Notify({Title = "ZenX", Content = "Complete System & Anti-AFK Ready!"})
